<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Add Crop Residue - Green Kisan</title>
<link rel="stylesheet" href="addcropresidue.css">
</head>
<body>

<div class="add-residue-container">

  <h1 class="add-title">Add Crop Residue</h1>

  <div class="add-residue-flex">

    <!-- Left: Form -->
    <div class="residue-card form-card">

      <form id="residueForm">

        <label>Crop Name</label>
        <select id="cropName" required>
          <option value="">Select Crop</option>
          <option value="Paddy">Paddy</option>
          <option value="Wheat">Wheat</option>
          <option value="Rice">Rice</option>
          <option value="Maize">Maize</option>
          <option value="Coconut">Coconut</option>
          <option value="Arecanut">Arecanut</option>
          <option value="Other">Other</option>
        </select>

        <label>Residue Type</label>
        <select id="residueType" required>
          <option value="">Select Type</option>
          <option value="Straw">Straw</option>
          <option value="Husk">Husk</option>
          <option value="Leaf">Leaf</option>
          <option value="Shell">Shell</option>
          <option value="Other">Other</option>
        </select>

        <label>Quantity (kg)</label>
        <input type="number" id="quantity" placeholder="e.g. 50" required>

        <label>Location</label>
        <input type="text" id="location" placeholder="Village / Town" required>

        <label>Uploader Name </label>
        <input type="text" id="uploaderName" placeholder="Your Name">

        <label>Uploader Contact </label>
        <input type="text" id="uploaderContact" placeholder="Phone / Email">

        <label>Upload Crop Residue Photos</label>
        <input type="file" id="residueImage" accept="image/*" capture="environment" multiple required>

        <div id="previewContainer"></div>

        <button type="submit" class="btn-submit">Submit</button>
        <button type="button" class="btn-back" onclick="goBack()">Back to Dashboard</button>

      </form>
    </div>

    <!-- Right: History -->
    <div class="history-panel">
      <h2>Upload History</h2>
      <div id="historyContainer"></div>
    </div>

  </div>
</div>

<script>
function goBack() {
  window.location.href="../farmerdashboard/farmerdashboard.html";
}

// Elements
const form = document.getElementById("residueForm");
const fileInput = document.getElementById("residueImage");
const previewContainer = document.getElementById("previewContainer");
const historyContainer = document.getElementById("historyContainer");

// Preview Images
fileInput.addEventListener("change", () => {
  previewContainer.innerHTML = "";
  const files = [...fileInput.files];

  if (files.length > 5) {
    alert("❌ Max 5 images allowed");
    fileInput.value = "";
    return;
  }

  files.forEach(file => {
    if (!file.type.startsWith("image/") || file.size > 2 * 1024 * 1024) {
      alert("❌ Each image must be <2MB and an image file.");
      fileInput.value = "";
      previewContainer.innerHTML = "";
      return;
    }

    const img = document.createElement("img");
    img.src = URL.createObjectURL(file);
    img.style.width = "100px";
    img.style.height = "100px";
    img.style.objectFit = "cover";
    img.style.borderRadius = "8px";
    img.style.margin = "6px";
    img.style.border = "1px solid #ccc";

    previewContainer.appendChild(img);
  });
});

// Load History
function loadHistory() {
  const residues = JSON.parse(localStorage.getItem("cropResidues") || "[]");
  if (!residues.length) {
    historyContainer.innerHTML = "<p>No uploads yet.</p>";
    return;
  }

  historyContainer.innerHTML = residues.map((item, index) => `
    <div class="history-card">
      <div class="history-images">
        ${item.images.map(img => `<img src="${img}" alt="Crop Image">`).join('')}
      </div>
      <div class="history-info">
        <p><strong>Crop:</strong> ${item.cropName}</p>
        <p><strong>Residue:</strong> ${item.residueType}</p>
        <p><strong>Quantity:</strong> ${item.quantity} kg</p>
        <p><strong>Location:</strong> ${item.location}</p>
        <p><strong>Uploader:</strong> ${item.uploaderName}</p>
        <p><strong>Contact:</strong> ${item.uploaderContact}</p>
        <button onclick="deleteEntry(${index})" class="btn-delete">Delete</button>
      </div>
    </div>
  `).join('');
}

// Delete Entry
function deleteEntry(index) {
  const residues = JSON.parse(localStorage.getItem("cropResidues") || "[]");
  residues.splice(index, 1);
  localStorage.setItem("cropResidues", JSON.stringify(residues));
  loadHistory();
}

// Form Submit
form.addEventListener("submit", async (e) => {
  e.preventDefault();

  if (!fileInput.files.length) {
    alert("❌ Upload at least 1 image");
    return;
  }

  const cropName = document.getElementById("cropName").value;
  const residueType = document.getElementById("residueType").value;
  const quantity = document.getElementById("quantity").value;
  const location = document.getElementById("location").value;
  const uploaderName = document.getElementById("uploaderName").value || "Anonymous";
  const uploaderContact = document.getElementById("uploaderContact").value || "Not Provided";

  // Convert images to Base64
  const files = [...fileInput.files];
  const images = await Promise.all(files.map(file => {
    return new Promise(resolve => {
      const reader = new FileReader();
      reader.onload = () => resolve(reader.result);
      reader.readAsDataURL(file);
    });
  }));

  const residueData = { cropName, residueType, quantity, location, uploaderName, uploaderContact, images };

  const existing = JSON.parse(localStorage.getItem("cropResidues") || "[]");
  existing.push(residueData);
  localStorage.setItem("cropResidues", JSON.stringify(existing));

  alert("✅ Crop residue uploaded successfully!");
  form.reset();
  previewContainer.innerHTML = "";
  loadHistory();
});

// Load history on page load
loadHistory();
</script>

</body>
</html>
